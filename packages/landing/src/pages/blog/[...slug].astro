---
import { type Document } from "@lydie-app/sdk";
import BlogPost from "../../layouts/BlogPost.astro";
import { LydieContent } from "../../components/LydieContent";
import { lydieClient } from "../../utils/lydie-client";
import FormattedDate from "../../components/FormattedDate.astro";

export async function getStaticPaths() {
  try {
    const { documents } = await lydieClient.getDocuments();
    return documents.map((doc) => ({
      params: { slug: doc.slug },
    }));
  } catch (error) {
    console.error("Failed to fetch documents for static paths:", error);
    // Return empty array to prevent build failure
    return [];
  }
}

// Get the slug from the URL parameters
const { slug } = Astro.params;

// Fetch the specific document using getDocument(slug)
let document: Document;
try {
  document = await lydieClient.getDocument(slug!, { related: true });
} catch (error) {
  console.error(`Failed to fetch document with slug "${slug}":`, error);
  // Return 404 response for missing or errored documents
  return new Response(null, {
    status: 404,
    statusText: "Blog post not found",
  });
}

const blogPostProps = {
  title: document.title,
};
---

<BlogPost {...blogPostProps}>
  <div class="max-w-2xl mx-auto">
    <header class="flex flex-col gap-y-4 mb-4">
      <h1 class="text-4xl font-bold text-gray-900">{document.title}</h1>
      <span class="text-gray-500">
        <FormattedDate date={new Date(document.createdAt)} />
      </span>
    </header>
    <article class="prose">
      <LydieContent
        content={document.jsonContent}
        customComponents={{}}
        client:load
      />
    </article>
    <hr class="my-8 border-gray-200" />
    <div class="flex flex-col gap-y-4">
      <span class="text-gray-500 text-sm"> Related posts </span>
      <div class="grid grid-cols-3">
        {
          document.related?.map((post: any) => (
            <a
              href={`/blog/${post.slug}`}
              class="rounded-lg bg-black/2 p-4 flex flex-col justify-end hover:bg-black/5 transition-colors duration-75 no-underline"
            >
              <span class="text-base font-medium text-gray-900">
                {post.title}
              </span>
              <p class="text-gray-500 text-sm">
                <FormattedDate date={new Date(post.createdAt)} />
              </p>
            </a>
          ))
        }
      </div>
    </div>
  </div>
</BlogPost>
