---
import { type Document } from "@lydie/sdk";
import BlogPost from "../../layouts/BlogPost.astro";
import { LydieContent } from "../../components/LydieContent";
import { lydieClient } from "../../utils/lydie-client";
import FormattedDate from "../../components/FormattedDate.astro";

export async function getStaticPaths() {
  try {
    const { documents } = await lydieClient.getDocuments();
    return documents.map((doc) => ({
      params: { slug: doc.slug },
    }));
  } catch (error) {
    console.error("Failed to fetch documents for static paths:", error);
    // Return empty array to prevent build failure
    return [];
  }
}

// Get the slug from the URL parameters
const { slug } = Astro.params;

// Fetch the specific document using getDocument(slug)
let document: Document;
try {
  document = await lydieClient.getDocument(slug!);
} catch (error) {
  console.error(`Failed to fetch document with slug "${slug}":`, error);
  // Return 404 response for missing or errored documents
  return new Response(null, {
    status: 404,
    statusText: "Blog post not found",
  });
}

const blogPostProps = {
  title: document.title,
  description: document.description,
};
---

<BlogPost {...blogPostProps}>
  <header class="flex flex-col gap-y-2">
    <div class="text-sm text-gray-500 mb-4">
      <!-- <FormattedDate date={new Date(document.createdAt)} />
      {
        document.updatedAt && (
          <span class="ml-4">
            Last updated: <FormattedDate date={document.updatedAt} />
          </span>
        )
      } -->
    </div>
    <h1 class="text-4xl font-bold text-gray-900">{document.title}</h1>
  </header>
  <div class="prose">
    <LydieContent
      content={document.jsonContent}
      customComponents={{}}
      client:load
    />
  </div>
</BlogPost>
