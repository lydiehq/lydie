---
import { getImage } from "astro:assets";
import type { ContentNode, TextNode } from "@lydie/core/content";
import { codeToHtml } from "shiki";

import {
  getFaqItems,
  getFlowchartEdges,
  getFlowchartNodes,
  getStringProperty,
  normalizeComponentKey,
} from "@/utils/content-component-props";

import ContentTextRenderer from "./ContentTextRenderer.astro";
import FAQBlock from "./FAQBlock.astro";
import { Flowchart } from "./Flowchart";
import { HeadingWithAnchor } from "./HeadingWithAnchor";

interface Props {
  node: ContentNode | TextNode;
  linkPrefix?: string;
  linkResolver?: (ref: {
    href: string;
    id?: string;
    slug?: string;
    title?: string;
    parentId?: string;
    parentSlug?: string;
    collectionHandle?: string;
    type?: "internal" | "external";
  }) => string;
  nextHeadingId: (text: string) => string;
}

const { node, linkPrefix, linkResolver, nextHeadingId } = Astro.props;

function isRecord(value: unknown): value is Record<string, unknown> {
  return Boolean(value) && typeof value === "object";
}

function getChildren(value: ContentNode | TextNode): Array<ContentNode | TextNode> {
  if (!("content" in value) || !Array.isArray(value.content)) {
    return [];
  }

  return value.content.filter((child): child is ContentNode | TextNode => isRecord(child));
}

function extractText(value: ContentNode | TextNode): string {
  if (value.type === "text") {
    const textValue = value as TextNode;
    return typeof textValue.text === "string" ? textValue.text : "";
  }

  return getChildren(value)
    .map((child) => extractText(child))
    .join(" ")
    .trim();
}

function extractCodeText(value: ContentNode): string {
  return getChildren(value)
    .filter((child) => child.type === "text")
    .map((child) => (typeof (child as TextNode).text === "string" ? (child as TextNode).text : ""))
    .join("");
}

function getRenderableRichTextNodes(value: ContentNode | null): Array<ContentNode | TextNode> {
  if (!value) {
    return [];
  }

  if (value.type === "doc") {
    return getChildren(value);
  }

  return [value];
}

function getRichTextProperty(properties: Record<string, unknown>, key: string): ContentNode | null {
  const value = properties[key];
  return value !== null && typeof value === "object" && "type" in value && value.type === "doc"
    ? (value as ContentNode)
    : null;
}

const attrs = isRecord("attrs" in node ? node.attrs : undefined)
  ? (node.attrs as Record<string, unknown>)
  : {};
const children = getChildren(node);

const headingLevel =
  typeof attrs.level === "number" && attrs.level >= 1 && attrs.level <= 6 ? attrs.level : 1;
const headingId = node.type === "heading" ? nextHeadingId(extractText(node).replace(/\s+/g, " ")) : "";

const componentName = typeof attrs.name === "string" ? attrs.name.trim() : "";
const componentProperties = isRecord(attrs.properties)
  ? (attrs.properties as Record<string, unknown>)
  : {};
const normalizedComponentName = normalizeComponentKey(componentName);
const componentBodyRichText = getRichTextProperty(componentProperties, "body");
const componentBodyNodes = getRenderableRichTextNodes(componentBodyRichText);
const pillarType = getStringProperty(componentProperties, "type") || "note";
const pillarHeading = getStringProperty(componentProperties, "heading") || "";

let pillarLabelClass = "text-slate-700";
let pillarHeadingClass = "text-slate-900";
let pillarBodyClass = "text-slate-700";
if (pillarType === "definition") {
  pillarLabelClass = "text-sky-700";
  pillarHeadingClass = "text-sky-950";
  pillarBodyClass = "text-sky-900/90";
} else if (pillarType === "tip") {
  pillarLabelClass = "text-emerald-700";
  pillarHeadingClass = "text-emerald-950";
  pillarBodyClass = "text-emerald-900/90";
} else if (pillarType === "warning") {
  pillarLabelClass = "text-amber-700";
  pillarHeadingClass = "text-amber-950";
  pillarBodyClass = "text-amber-900/90";
}

const imageSrc = typeof attrs.src === "string" ? attrs.src : "";
const imageAlt = typeof attrs.alt === "string" ? attrs.alt : "";
const imageTitle = typeof attrs.title === "string" ? attrs.title : undefined;
const imageWidth = typeof attrs.width === "number" ? attrs.width : undefined;
const imageHeight = typeof attrs.height === "number" ? attrs.height : undefined;

let optimizedImage: Awaited<ReturnType<typeof getImage>> | null = null;
if (node.type === "image" && imageSrc) {
  try {
    optimizedImage = await getImage({
      src: imageSrc,
      alt: imageAlt,
      width: imageWidth || 800,
      height: imageHeight || 600,
      inferSize: !imageWidth || !imageHeight,
      format: "webp",
      quality: 80,
    });
  } catch (error) {
    console.warn(`[LydieContent] Failed to optimize image: ${imageSrc}`, error);
  }
}

const codeLanguage = typeof attrs.language === "string" ? attrs.language : undefined;
let highlightedCodeHtml: string | null = null;
if (node.type === "codeBlock") {
  const code = extractCodeText(node as ContentNode);

  try {
    highlightedCodeHtml = await codeToHtml(code, {
      lang: codeLanguage || "text",
      theme: "github-light",
    });
  } catch (error) {
    console.warn("[LydieContent] Error highlighting code:", error);
  }
}

const orderedListStart = typeof attrs.start === "number" ? attrs.start : undefined;
const taskChecked = typeof attrs.checked === "boolean" ? attrs.checked : undefined;
const tableColspan = typeof attrs.colspan === "number" && attrs.colspan > 1 ? attrs.colspan : undefined;
const tableRowspan = typeof attrs.rowspan === "number" && attrs.rowspan > 1 ? attrs.rowspan : undefined;
const textNode = node.type === "text" ? (node as TextNode) : null;
---

{node.type === "text" && (
  <ContentTextRenderer
    text={textNode?.text || ""}
    marks={textNode?.marks}
    linkPrefix={linkPrefix}
    linkResolver={linkResolver}
  />
)}

{node.type === "doc" && (
  children.map((child) => (
    <Astro.self node={child} linkPrefix={linkPrefix} linkResolver={linkResolver} nextHeadingId={nextHeadingId} />
  ))
)}

{node.type === "paragraph" && (
  <p>
    {children.map((child) => (
      <Astro.self
        node={child}
        linkPrefix={linkPrefix}
        linkResolver={linkResolver}
        nextHeadingId={nextHeadingId}
      />
    ))}
  </p>
)}

{node.type === "heading" && (
  <HeadingWithAnchor level={headingLevel} headingId={headingId}>
    {children.map((child) => (
      <Astro.self
        node={child}
        linkPrefix={linkPrefix}
        linkResolver={linkResolver}
        nextHeadingId={nextHeadingId}
      />
    ))}
  </HeadingWithAnchor>
)}

{node.type === "bulletList" && (
  <ul>
    {children.map((child) => (
      <Astro.self node={child} linkPrefix={linkPrefix} linkResolver={linkResolver} nextHeadingId={nextHeadingId} />
    ))}
  </ul>
)}

{node.type === "orderedList" && (
  <ol start={orderedListStart}>
    {children.map((child) => (
      <Astro.self node={child} linkPrefix={linkPrefix} linkResolver={linkResolver} nextHeadingId={nextHeadingId} />
    ))}
  </ol>
)}

{node.type === "listItem" && (
  <li>
    {children.map((child) => (
      <Astro.self node={child} linkPrefix={linkPrefix} linkResolver={linkResolver} nextHeadingId={nextHeadingId} />
    ))}
  </li>
)}

{node.type === "taskList" && (
  <ul data-type="taskList">
    {children.map((child) => (
      <Astro.self node={child} linkPrefix={linkPrefix} linkResolver={linkResolver} nextHeadingId={nextHeadingId} />
    ))}
  </ul>
)}

{node.type === "taskItem" && (
  <li data-type="taskItem" data-checked={taskChecked}>
    {children.map((child) => (
      <Astro.self node={child} linkPrefix={linkPrefix} linkResolver={linkResolver} nextHeadingId={nextHeadingId} />
    ))}
  </li>
)}

{node.type === "horizontalRule" && (
  <hr />
)}

{node.type === "blockquote" && (
  <blockquote>
    {children.map((child) => (
      <Astro.self node={child} linkPrefix={linkPrefix} linkResolver={linkResolver} nextHeadingId={nextHeadingId} />
    ))}
  </blockquote>
)}

{node.type === "codeBlock" && highlightedCodeHtml && (
    <div class="rounded-lg bg-gray-50 border border-gray-200 p-3 my-0 overflow-x-auto [&_pre]:bg-transparent! [&_pre]:p-0! [&_pre]:m-0! [&_pre]:border-0! [&_pre]:overflow-x-auto!">
      <Fragment set:html={highlightedCodeHtml} />
    </div>
)}

{node.type === "codeBlock" && !highlightedCodeHtml && (
    <div class="rounded-lg bg-gray-50 border border-gray-200 p-3 my-0 overflow-x-auto">
      <pre>
        <code class={codeLanguage ? `language-${codeLanguage}` : undefined}>
          {extractCodeText(node as ContentNode)}
        </code>
      </pre>
    </div>
)}

{node.type === "image" && imageSrc && (
  <div class="my-6 flex justify-center">
    <img
      src={optimizedImage?.src || imageSrc}
      srcset={optimizedImage?.srcSet?.attribute}
      sizes="(max-width: 672px) 100vw, 672px"
      alt={imageAlt}
      title={imageTitle}
      width={optimizedImage?.attributes?.width || imageWidth}
      height={optimizedImage?.attributes?.height || imageHeight}
      class="rounded-lg border border-black/8 max-w-full h-auto"
      loading="lazy"
      decoding="async"
    />
  </div>
)}

{node.type === "table" && (
  <table>
    {children.map((child) => (
      <Astro.self node={child} linkPrefix={linkPrefix} linkResolver={linkResolver} nextHeadingId={nextHeadingId} />
    ))}
  </table>
)}

{node.type === "tableRow" && (
  <tr>
    {children.map((child) => (
      <Astro.self node={child} linkPrefix={linkPrefix} linkResolver={linkResolver} nextHeadingId={nextHeadingId} />
    ))}
  </tr>
)}

{node.type === "tableHeader" && (
  <th colspan={tableColspan} rowspan={tableRowspan}>
    {children.map((child) => (
      <Astro.self node={child} linkPrefix={linkPrefix} linkResolver={linkResolver} nextHeadingId={nextHeadingId} />
    ))}
  </th>
)}

{node.type === "tableCell" && (
  <td colspan={tableColspan} rowspan={tableRowspan}>
    {children.map((child) => (
      <Astro.self node={child} linkPrefix={linkPrefix} linkResolver={linkResolver} nextHeadingId={nextHeadingId} />
    ))}
  </td>
)}

{(node.type === "customBlock" || node.type === "documentComponent") &&
  normalizedComponentName === "pillarcallout" && (
    <aside class="my-8 relative">
      <div class="absolute -top-1.5 bg-linear-to-r h-px from-transparent via-black/5 to-transparent from-2% to-98% -left-100 -right-100 -z-10"></div>
      <div class="absolute -bottom-1.5 bg-linear-to-r h-px from-transparent via-black/5 to-transparent from-2% to-98% -left-100 -right-100 -z-10"></div>
      <div class="absolute -right-1.5 bg-linear-to-t w-px from-transparent via-black/5 to-transparent from-2% to-98% -top-100 -bottom-100 -z-10"></div>
      <div class="absolute -left-1.5 bg-linear-to-b w-px from-transparent via-black/5 to-transparent from-2% to-98% -top-100 -bottom-100 -z-10"></div>
      <div class="rounded-xl shadow-legit overflow-hidden bg-white p-5 ring ring-black/5">
        <p class={`m-0 text-xs font-semibold uppercase tracking-wide ${pillarLabelClass}`}>
          {pillarType}
        </p>
        {pillarHeading ? (
          <h3 class={`mt-2 mb-0 text-lg font-semibold ${pillarHeadingClass}`}>
            {pillarHeading}
          </h3>
        ) : null}
        {componentBodyNodes.length > 0 ? (
          <div class={`mt-2 ${pillarBodyClass} leading-relaxed`}>
            {componentBodyNodes.map((bodyNode) => (
              <Astro.self
                node={bodyNode}
                linkPrefix={linkPrefix}
                linkResolver={linkResolver}
                nextHeadingId={nextHeadingId}
              />
            ))}
          </div>
        ) : getStringProperty(componentProperties, "body") ? (
          <p class={`mt-2 mb-0 leading-relaxed ${pillarBodyClass}`}>
            {getStringProperty(componentProperties, "body")}
          </p>
        ) : null}
      </div>
    </aside>
  )}

{(node.type === "customBlock" || node.type === "documentComponent") &&
  normalizedComponentName === "flowchart" && (
    <Flowchart
      title={getStringProperty(componentProperties, "title") || undefined}
      nodes={getFlowchartNodes(componentProperties.nodes)}
      edges={getFlowchartEdges(componentProperties.edges)}
    />
  )}

{(node.type === "customBlock" || node.type === "documentComponent") &&
  normalizedComponentName === "faq" && (
    <FAQBlock
      title={getStringProperty(componentProperties, "title") || undefined}
      items={getFaqItems(componentProperties.items)}
    />
  )}

{(node.type === "customBlock" || node.type === "documentComponent") &&
  normalizedComponentName === "tldr" && (
    <aside class="my-8 relative">
      <div class="absolute -top-1.5 bg-linear-to-r h-px from-transparent via-black/5 to-transparent from-2% to-98% -left-100 -right-100 -z-10"></div>
      <div class="absolute -bottom-1.5 bg-linear-to-r h-px from-transparent via-black/5 to-transparent from-2% to-98% -left-100 -right-100 -z-10"></div>
      <div class="absolute -right-1.5 bg-linear-to-t w-px from-transparent via-black/5 to-transparent from-2% to-98% -top-100 -bottom-100 -z-10"></div>
      <div class="absolute -left-1.5 bg-linear-to-b w-px from-transparent via-black/5 to-transparent from-2% to-98% -top-100 -bottom-100 -z-10"></div>
      <div class="rounded-xl shadow-legit overflow-hidden bg-white p-5 ring ring-black/5">
        <p class="m-0 text-xs font-semibold uppercase tracking-wide text-rose-700">TLDR</p>
        {componentBodyNodes.length > 0 ? (
          <div class="mt-2 text-rose-950 leading-relaxed">
            {componentBodyNodes.map((bodyNode) => (
              <Astro.self
                node={bodyNode}
                linkPrefix={linkPrefix}
                linkResolver={linkResolver}
                nextHeadingId={nextHeadingId}
              />
            ))}
          </div>
        ) : getStringProperty(componentProperties, "body") ? (
          <p class="mt-2 mb-0 leading-relaxed text-rose-950">
            {getStringProperty(componentProperties, "body")}
          </p>
        ) : null}
      </div>
    </aside>
  )}
