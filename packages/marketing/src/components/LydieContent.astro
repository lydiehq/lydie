---
import { getImage } from "astro:assets";
import type { ContentNode } from "@lydie-app/sdk";
import {
  renderContent,
  type RenderContentResult,
  type ImageComponentProps,
  blogImageComponent,
} from "../utils/content-renderer";
import {
  linkGridComponent,
  comparisonGridComponent,
  visualFrameworkComponent,
  flowStepsComponent,
} from "../utils/custom-components";

interface Props {
  content: ContentNode;
  linkPrefix?: string;
  linkResolver?: (ref: {
    href: string;
    id?: string;
    slug?: string;
    title?: string;
    parentSlug?: string;
    collectionHandle?: string;
    type?: "internal" | "external";
  }) => string;
}

const { content, linkPrefix, linkResolver } = Astro.props;

  // Custom image component that uses Astro's Image optimization
async function astroImageComponent(props: ImageComponentProps): Promise<string> {
  const { src, alt, title, width, height } = props;

  try {
    const optimized = await getImage({
      src,
      alt: alt || "",
      width: width || 800,
      height: height || 600,
      inferSize: !width || !height,
      format: "webp",
      quality: 80,
    });

    const altAttr = alt ? ` alt="${alt}"` : "";
    const titleAttr = title ? ` title="${title}"` : "";
    const widthAttr = optimized.attributes?.width
      ? ` width="${optimized.attributes.width}"`
      : "";
    const heightAttr = optimized.attributes?.height
      ? ` height="${optimized.attributes.height}"`
      : "";
    const srcset = optimized.srcSet?.attribute
      ? ` srcset="${optimized.srcSet.attribute}"`
      : "";
    // Blog content is in max-w-2xl container (~672px), so use appropriate sizes
    const sizes = ` sizes="(max-width: 672px) 100vw, 672px"`;

    return `<div class="my-6 flex justify-center">
      <img
        src="${optimized.src}"
        ${srcset}${sizes}${altAttr}${titleAttr}${widthAttr}${heightAttr}
        class="rounded-lg border border-black/8 max-w-full h-auto"
        loading="lazy"
        decoding="async"
      />
    </div>`;
  } catch (error) {
    // Fallback to blog image component if optimization fails
    console.warn(`[LydieContent] Failed to optimize image: ${src}`, error);
    return blogImageComponent(props);
  }
}

// First pass: render content to get HTML and image list
const { html, images } = await renderContent(content, {
  linkPrefix,
  linkResolver,
  components: {
    // Use default image component for first pass
    image: blogImageComponent,
    // Custom document components
    linkGrid: linkGridComponent,
    comparisonGrid: comparisonGridComponent,
    visualFramework: visualFrameworkComponent,
    flowSteps: flowStepsComponent,
  },
});

// Create a map of optimized images
const optimizedImages = new Map<string, string>();
for (const image of images) {
  optimizedImages.set(image.src, await astroImageComponent(image));
}

// Replace image placeholders in HTML with optimized versions
let finalHtml = html;
for (const [originalSrc, optimizedHtml] of optimizedImages) {
  // Find and replace the blog image component output with optimized version
  const escapedSrc = originalSrc.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
  const blogPattern = new RegExp(
    `<div class="my-6 flex justify-center">\\s*<img[^>]*src="${escapedSrc}"[^>]*/?>\\s*</div>`,
    "g",
  );
  finalHtml = finalHtml.replace(blogPattern, optimizedHtml);
}
---

<div set:html={finalHtml} />
