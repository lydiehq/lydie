---
import Layout from "../../../layouts/Layout.astro";
import { Container } from "../../../components/Container";
import Breadcrumbs from "../../../components/Breadcrumbs.astro";
import { Button } from "../../../components/generic/Button";
import { ChevronRightRegular } from "@fluentui/react-icons";
import { FAQSection } from "../../../components/tools/FAQSection";
import { GradientOutline } from "../../../components/generic/GradientOutline";
import Divider from "../../../components/landing/Divider.astro";
import { CTASection } from "../../../components/landing/CTASection";
import {
  features,
  type FeatureSubpage,
  getFeature,
  getFeatureSubpage,
} from "../../../data/features";

export function getStaticPaths() {
  const paths: Array<{ params: { slug: string; subpage: string } }> = [];
  for (const feature of features) {
    if (feature.subpages) {
      for (const subpage of feature.subpages) {
        paths.push({
          params: { slug: feature.slug, subpage: subpage.slug },
        });
      }
    }
  }
  return paths;
}

const { slug, subpage } = Astro.params;
const feature = getFeature(slug!);
const subpageData: FeatureSubpage | undefined = getFeatureSubpage(
  slug!,
  subpage!,
);

if (!feature || !subpageData) {
  return Astro.redirect("/404");
}

const {
  metaTitle,
  metaDescription,
  headline,
  subheadline,
  ctaText,
  faqs,
  content,
  accentColor,
  secondaryAccentColor,
} = subpageData;

// Parse content sections to separate paragraphs from headings
const contentSections = content.map((section) => {
  if (section.startsWith("## ")) {
    return { type: "heading", text: section.replace("## ", "") };
  }
  return { type: "paragraph", text: section };
});
---

<style define:vars={{ accentColor, secondaryAccentColor }}>
  .feature-text {
    position: relative;
    display: inline-block;
  }

  .feature-highlight {
    position: absolute;
    left: -2px;
    top: -2px;
    bottom: -2px;
    border-radius: 8px;
    z-index: -1;
    width: 0;
    opacity: 0;
    animation: highlight-grow 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    background-color: var(--accentColor);
  }

  .feature-highlight-rtl {
    position: absolute;
    right: -2px;
    top: -2px;
    bottom: -2px;
    border-radius: 8px;
    z-index: -1;
    width: 0;
    opacity: 0;
    animation: highlight-grow-rtl 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)
      forwards;
    background-color: var(--secondaryAccentColor, var(--accentColor));
  }

  @keyframes highlight-grow {
    0% {
      width: 0;
      opacity: 0;
    }
    100% {
      width: calc(100% + 4px);
      opacity: 1;
    }
  }

  @keyframes highlight-grow-rtl {
    0% {
      width: 0;
      opacity: 0;
    }
    100% {
      width: calc(100% + 4px);
      opacity: 1;
    }
  }

  @keyframes sparkle-appear {
    0% {
      opacity: 0;
      transform: scale(0.5) rotate(-20deg);
    }
    50% {
      transform: scale(1.2) rotate(10deg);
    }
    100% {
      opacity: 1;
      transform: scale(1) rotate(0deg);
    }
  }

  .sparkle-wrapper {
    animation: sparkle-appear 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    opacity: 0;
    position: absolute;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .sparkle-wrapper-right {
    right: -24px;
    top: -8px;
  }

  .sparkle-wrapper-left {
    left: -24px;
    top: -8px;
  }
</style>

<Layout title={metaTitle} description={metaDescription}>
  <div class="max-w-4xl relative">
    <div
      class="fixed inset-y-0 w-1 border-r border-black/4"
      style="left: calc(50% - 388px)"
    >
    </div>
    <div
      class="fixed inset-y-0 w-1 border-r border-black/4"
      style="right: calc(50% - 388px)"
    >
    </div>
  </div>
  <Container
    className="flex flex-col items-center justify-center min-h-[60vh] py-16 gap-y-32"
  >
    <div class="w-full max-w-4xl">
      <Breadcrumbs
        items={[
          { label: "Features", href: "/features" },
          { label: feature.title, href: `/features/${slug}` },
          { label: subpageData.title },
        ]}
      />
    </div>
    <div class="text-center relative py-12 size-full">
      <GradientOutline />
      <h1
        class="text-3xl font-medium text-black/85 tracking-tight mb-6 leading-tight"
      >
        <span class="feature-text">
          {headline}
          <span
            class="feature-highlight"
            style={`background-color: ${accentColor}33; animation-delay: 0s;`}
          ></span>
          <span
            class="sparkle-wrapper sparkle-wrapper-right"
            style="animation-delay: 0.5s;"
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M12 2L13.09 8.26L19 7L15.74 10.26L22 12L15.74 13.74L19 17L13.09 15.74L12 22L10.91 15.74L5 17L8.26 13.74L2 12L8.26 10.26L5 7L10.91 8.26L12 2Z"
                fill={accentColor}
                stroke={accentColor}
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
              </path>
            </svg>
          </span>
        </span>
      </h1>
      <p class="text-base text-black/60 max-w-md mx-auto mb-8 text-balance">
        {subheadline.split(". ")[0]}.<br />
        <span class="feature-text">
          {
            subheadline
              .split(". ")
              .slice(1)
              .join(". ")
              .split(" ")
              .slice(0, 4)
              .join(" ")
          }
          <span
            class="feature-highlight-rtl"
            style={`background-color: ${secondaryAccentColor || accentColor}33; animation-delay: 0.2s;`}
          ></span>
          {
            secondaryAccentColor && (
              <span
                class="sparkle-wrapper sparkle-wrapper-left"
                style="animation-delay: 0.7s;"
              >
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M12 2L13.5 8.5L20 7L15 11L20 15L13.5 13.5L12 20L10.5 13.5L4 15L9 11L4 7L10.5 8.5L12 2Z"
                    fill={secondaryAccentColor}
                    stroke={secondaryAccentColor}
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </span>
            )
          }
        </span>
        {
          subheadline
            .split(". ")
            .slice(1)
            .join(". ")
            .split(" ")
            .slice(4)
            .join(" ")
        }
      </p>
      <div class="flex items-center justify-center gap-4">
        <Button href="https://app.lydie.co/auth" size="lg" intent="primary">
          <span>{ctaText}</span>
          <ChevronRightRegular className="size-4" />
        </Button>
        <a
          href={`/features/${slug}`}
          class="text-black/70 hover:text-black transition-colors text-sm font-medium"
        >
          All {feature.title} features
        </a>
      </div>
    </div>
    <div class="max-w-xl mx-auto flex flex-col gap-y-8">
      <div class="prose mx-auto">
        {
          contentSections.map((section) => {
            if (section.type === "heading") {
              return <h2>{section.text}</h2>;
            }
            return <p>{section.text}</p>;
          })
        }
      </div>
      <Divider />
      <FAQSection faqs={faqs} client:load />
    </div>
  </Container>
  <CTASection client:load />
</Layout>
