---
export const prerender = false;

Astro.response.headers.set(
  "Cache-Control",
  "public, max-age=3600, s-maxage=3600, stale-while-revalidate=86400",
);

import type { ContentNode } from "@lydie/core/content";

import ArticleHeadingEnhancements from "@/components/ArticleHeadingEnhancements.astro";
import Breadcrumbs from "@/components/Breadcrumbs.astro";
import { Container } from "@/components/Container";
import PillarTOC from "@/components/PillarTOC.astro";
import Layout from "@/layouts/Layout.astro";
import { articleTypographyClassName } from "@/utils/article-typography";
import { renderContent, blogImageComponent } from "@/utils/content-renderer";
import {
  faqComponent,
  flowchartComponent,
  pillarCalloutComponent,
} from "@/utils/custom-components";
import * as lydieApi from "@/utils/lydie-client";
import { createLinkResolver } from "@/utils/route-registry";

const { pillar, article } = Astro.params;

if (!pillar) {
  return new Response(null, { status: 404 });
}

const pillarCollectionMap: Record<string, string> = {
  "knowledge-bases": lydieApi.collections.knowledgeBases,
  "note-taking": lydieApi.collections.noteTaking,
};

const collectionHandle = pillarCollectionMap[pillar] || pillar;
const requestedPath = article ? `/${article}` : "/";

type CollectionDocument = lydieApi.CollectionApiDocument & {
  path?: string;
};

let currentDocument: CollectionDocument | null = null;
let rootDocument: CollectionDocument | null = null;
let allDocuments: CollectionDocument[] = [];
let documentsForToc: CollectionDocument[] = [];
let contentHtml = "";

const linkResolver = createLinkResolver({
  currentCollectionHandle: collectionHandle,
});

console.log(
  `[Resource Hub] Fetching document: ${collectionHandle}${requestedPath}`,
);

try {
  // Fetch all documents with their computed paths
  const { documents } = await lydieApi.getCollectionDocumentsWithPaths(collectionHandle, {
    sortBy: "created_at",
    sortOrder: "asc",
    includeToc: true,
    includeRelated: true,
  });
  allDocuments = documents as CollectionDocument[];

  // Find the document matching the requested path
  const normalizedTarget =
    requestedPath === "/" ? "/" : requestedPath.replace(/\/$/, "");
  currentDocument =
    allDocuments.find((doc) => {
      const docPath = doc.path || "/";
      const normalizedDocPath =
        docPath === "/" ? "/" : docPath.replace(/\/$/, "");
      return normalizedDocPath === normalizedTarget;
    }) || null;

  if (!currentDocument) {
    throw new Error("Document not found");
  }

  const resolvedDocument = currentDocument;

  // Find root document (the one without a parent)
  rootDocument =
    allDocuments.find((doc) => {
      const parentId = doc.fields?.parent as string | undefined;
      return !parentId;
    }) || null;

  documentsForToc = allDocuments.map((doc) =>
    doc.id === resolvedDocument.id
      ? {
          ...doc,
          toc: resolvedDocument.toc,
        }
      : doc,
  );

  if (!documentsForToc.some((doc) => doc.id === resolvedDocument.id)) {
    documentsForToc = [resolvedDocument, ...documentsForToc];
  }

  const { html } = await renderContent(
    resolvedDocument.jsonContent as ContentNode,
    {
      components: {
        image: blogImageComponent,
        pillarCallout: pillarCalloutComponent,
        flowchart: flowchartComponent,
        faq: faqComponent,
        FAQ: faqComponent,
      },
      linkResolver,
    },
  );
  contentHtml = html;
} catch (error) {
  console.error(
    `[Resource Hub] Failed to fetch document ${collectionHandle}${requestedPath}`,
    error,
  );
  return new Response(null, { status: 404 });
}

if (!currentDocument) {
  return new Response(null, { status: 404 });
}

const pageDocument = currentDocument;
const description = pageDocument.fields?.description || pageDocument.title || "Article";
const breadcrumbItems = [
  { label: "Home", href: "/" },
  {
    label: rootDocument?.title || pillar.replace(/-/g, " "),
    href: `/${pillar}`,
  },
  { label: pageDocument.title || "Article" },
].filter((item, index, items) => index === 0 || item.label !== items[index - 1]?.label);
const relatedDocuments =
  pageDocument.related && pageDocument.related.length > 0
    ? pageDocument.related
    : allDocuments.filter((doc) => doc.id !== pageDocument.id);
---

<Layout
  title={pageDocument.title || "Resources"}
  description={String(description)}
>
  <div class="py-8">
    <Container>
      <Breadcrumbs items={breadcrumbItems} />

      <div class="flex gap-8 mt-8 relative">
        <aside class="hidden lg:block lg:order-1 lg:w-80 xl:w-96 shrink-0">
          <PillarTOC
            documents={documentsForToc}
            currentDocumentId={pageDocument.id}
            pillar={pillar}
          />
        </aside>
        <article
          class="flex-1 max-w-3xl lg:order-2 lg:ml-auto"
        >
          <header class="mb-8">
            <h1 class="text-3xl font-semibold text-gray-900">
              {pageDocument.title}
            </h1>
            {
              pageDocument.fields?.description && (
                <p class="text-lg text-gray-600 mt-4">
                  {pageDocument.fields?.description}
                </p>
              )
            }
          </header>

          <div class={articleTypographyClassName}>
            <Fragment set:html={contentHtml} />
          </div>
          <ArticleHeadingEnhancements />

          {relatedDocuments.length > 0 && (
            <section class="mt-16 pt-8 border-t border-gray-200">
              <h2 class="text-xl font-semibold text-gray-900 mb-6">Related Articles</h2>
              <div class="grid gap-4">
                {relatedDocuments.map((doc) => (
                  <a
                    href={
                      doc.path === "/"
                        ? `/${pillar}`
                        : `/${pillar}${typeof doc.path === "string" ? doc.path : `/${doc.id}`}`
                    }
                    class="group block p-4 bg-white border border-gray-200 rounded-lg hover:border-blue-500/50 hover:shadow-md transition-all"
                  >
                    <h3 class="font-medium text-gray-900 group-hover:text-blue-600 transition-colors">
                      {doc.title}
                    </h3>
                  </a>
                ))}
              </div>
            </section>
          )}
        </article>
      </div>
    </Container>
  </div>
</Layout>
