---
export const prerender = false;

Astro.response.headers.set(
  "Cache-Control",
  "public, max-age=3600, s-maxage=3600, stale-while-revalidate=86400",
);

import type { ContentNode } from "@lydie/core/content";

import ArticleHeadingEnhancements from "@/components/ArticleHeadingEnhancements.astro";
import Breadcrumbs from "@/components/Breadcrumbs.astro";
import { Container } from "@/components/Container";
import LydieContent from "@/components/LydieContent.astro";
import PillarTOC from "@/components/PillarTOC.astro";
import RelatedDocumentCard from "@/components/RelatedDocumentCard.astro";
import { GeometricPatternIllustration } from "@/components/illustrations/GeometricPatternIllustration";
import Layout from "@/layouts/Layout.astro";
import { articleTypographyClassName } from "@/utils/article-typography";
import * as lydieApi from "@/utils/lydie-client";
import { createLinkResolver } from "@/utils/route-registry";

const { pillar, article } = Astro.params;

if (!pillar) {
  return new Response(null, { status: 404 });
}

const pillarCollectionMap = {
  "knowledge-bases": lydieApi.collections.knowledgeBases,
  "note-taking": lydieApi.collections.noteTaking,
} as const;

if (!(pillar in pillarCollectionMap)) {
  return new Response(null, { status: 404 });
}

const collectionHandle = pillarCollectionMap[pillar as keyof typeof pillarCollectionMap];
const requestedPath = article ? `/${article}` : "/";

type CollectionDocument = lydieApi.CollectionApiDocument & {
  path?: string;
};

type RelatedCollectionDocument = {
  id: string;
  title: string;
  createdAt?: string;
  coverImage?: string | null;
  slug?: string;
  fields?: Record<string, unknown>;
};

function getMarketingSlug(value: unknown): string | null {
  if (typeof value !== "string") return null;
  const normalized = value.trim().replace(/^\/+|\/+$/g, "");
  return normalized.length > 0 ? normalized : null;
}

let currentDocument: CollectionDocument | null = null;
let rootDocument: CollectionDocument | null = null;
let allDocuments: CollectionDocument[] = [];
let documentsForToc: CollectionDocument[] = [];
let relatedDocuments: Array<RelatedCollectionDocument & { path?: string }> = [];

const linkResolver = createLinkResolver({
  currentCollectionHandle: collectionHandle,
});

console.log(
  `[Resource Hub] Fetching document: ${collectionHandle}${requestedPath}`,
);

try {
  // Fetch all documents with their computed paths
  const { documents } = await lydieApi.getCollectionDocumentsWithPaths(
    collectionHandle,
    {
      sortBy: "created_at",
      sortOrder: "asc",
      includeToc: true,
      includeRelated: true,
      relatedScope: "collection_handle",
      relatedCollectionHandle: lydieApi.collections.knowledgeBases,
      relatedLimit: 2,
    } as unknown as Parameters<
      typeof lydieApi.getCollectionDocumentsWithPaths
    >[1],
  );
  allDocuments = documents as CollectionDocument[];

  // Find the document matching the requested path
  const normalizedTarget =
    requestedPath === "/" ? "/" : requestedPath.replace(/\/$/, "");
  currentDocument =
    allDocuments.find((doc) => {
      const docPath = doc.path || "/";
      const normalizedDocPath =
        docPath === "/" ? "/" : docPath.replace(/\/$/, "");
      return normalizedDocPath === normalizedTarget;
    }) || null;

  if (!currentDocument) {
    throw new Error("Document not found");
  }

  const resolvedDocument = currentDocument;

  // Find root document (the one without a parent)
  rootDocument =
    allDocuments.find((doc) => {
      const parentId = doc.fields?.parent as string | undefined;
      return !parentId;
    }) || null;

  documentsForToc = allDocuments.map((doc) =>
    doc.id === resolvedDocument.id
      ? {
          ...doc,
          toc: resolvedDocument.toc,
        }
      : doc,
  );

  if (!documentsForToc.some((doc) => doc.id === resolvedDocument.id)) {
    documentsForToc = [resolvedDocument, ...documentsForToc];
  }

  const relatedFromApi = (resolvedDocument.related ||
    []) as RelatedCollectionDocument[];

  const knowledgeBaseDocuments =
    collectionHandle === lydieApi.collections.knowledgeBases
      ? allDocuments
      : ((
          await lydieApi.getCollectionDocumentsWithPaths(
            lydieApi.collections.knowledgeBases,
            {
              sortBy: "created_at",
              sortOrder: "asc",
            },
          )
        ).documents as CollectionDocument[]);

  relatedDocuments = relatedFromApi
    .map((doc) => {
      const matchingDoc = knowledgeBaseDocuments.find(
        (entry) => entry.id === doc.id,
      );
      return {
        ...doc,
        path: matchingDoc?.path,
      };
    })
    .filter((doc) => doc.id !== resolvedDocument.id)
    .slice(0, 2);
} catch (error) {
  console.error(
    `[Resource Hub] Failed to fetch document ${collectionHandle}${requestedPath}`,
    error,
  );
  return new Response(null, { status: 404 });
}

if (!currentDocument) {
  return new Response(null, { status: 404 });
}

const pageDocument = currentDocument;
const isPillarIndex = requestedPath === "/";
const description =
  pageDocument.fields?.description || pageDocument.title || "Article";
const pageSeed = `${collectionHandle}:${String(pageDocument.path || pageDocument.id)}`;
const breadcrumbItems = [
  { label: "Home", href: "/" },
  {
    label: rootDocument?.title || pillar.replace(/-/g, " "),
    href: `/${pillar}`,
  },
  { label: pageDocument.title || "Article" },
].filter(
  (item, index, items) => index === 0 || item.label !== items[index - 1]?.label,
);
---

<Layout
  title={pageDocument.title || "Resources"}
  description={String(description)}
>
  <div class="py-8">
    <Container>
      <Breadcrumbs items={breadcrumbItems} />

      {
        isPillarIndex && (
          <section class="mx-auto mt-8 mb-12 max-w-3xl text-center">
            <h1 class="text-4xl md:text-5xl font-semibold text-gray-900 tracking-tight">
              {pageDocument.title}
            </h1>
            {pageDocument.fields?.description && (
              <p class="text-lg text-gray-600 mt-4 max-w-2xl mx-auto">
                {pageDocument.fields?.description}
              </p>
            )}
            <div class="mt-8 w-full aspect-[21/10]">
              <GeometricPatternIllustration seed={pageSeed} radius="lg" />
            </div>
          </section>
        )
      }

      <div class="flex gap-8 mt-8 relative">
        <div class="flex-1">
          <article class="w-[60ch]">
            <header class="mb-8">
              {
                !isPillarIndex && (
                  <>
                    <h1 class="text-3xl font-semibold text-gray-900">
                      {pageDocument.title}
                    </h1>
                    {pageDocument.fields?.description && (
                      <p class="text-lg text-gray-600 mt-4">
                        {pageDocument.fields?.description}
                      </p>
                    )}
                  </>
                )
              }
              {
                !isPillarIndex && (
                  <div class="mt-6 w-full aspect-[21/10]">
                    <GeometricPatternIllustration seed={pageSeed} radius="md" />
                  </div>
                )
              }
            </header>

            <div class={articleTypographyClassName}>
              <LydieContent
                content={pageDocument.jsonContent as ContentNode}
                linkResolver={linkResolver}
              />
            </div>
            <ArticleHeadingEnhancements />

            {
              relatedDocuments.length > 0 && (
                <section class="mt-16 pt-8 border-t border-gray-200">
                  <h2 class="text-xl font-semibold text-gray-900 mb-6">
                    Related Articles
                  </h2>
                  <div class="grid gap-4">
                    {relatedDocuments.map((doc) => (
                      <RelatedDocumentCard
                        href={
                          typeof doc.path === "string"
                            ? doc.path === "/"
                              ? "/knowledge-bases"
                              : `/knowledge-bases${doc.path}`
                            : (() => {
                                const relatedSlug = getMarketingSlug(
                                  doc.fields?.slug ?? doc.slug,
                                );
                                return relatedSlug
                                  ? `/knowledge-bases/${relatedSlug}`
                                  : `/knowledge-bases/${doc.id}`;
                              })()
                        }
                        title={doc.title}
                        createdAt={doc.createdAt}
                        coverImage={doc.coverImage}
                        seed={String(doc.fields?.slug ?? doc.slug ?? doc.id)}
                      />
                    ))}
                  </div>
                </section>
              )
            }
          </article>
        </div>
        <aside class="hidden lg:block lg:order-2 w-68 shrink-0">
          <PillarTOC
            documents={documentsForToc}
            currentDocumentId={pageDocument.id}
            pillar={pillar}
          />
        </aside>
      </div>
    </Container>
  </div>
</Layout>
