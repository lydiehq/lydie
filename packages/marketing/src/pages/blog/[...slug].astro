---
export const prerender = false;

Astro.response.headers.set(
  "Cache-Control",
  "public, max-age=3600, s-maxage=86400, stale-while-revalidate=604800",
);

import { Image } from "astro:assets";
import BlogPost from "../../layouts/BlogPost.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import * as lydieApi from "../../utils/lydie-client";
import { createLinkResolver } from "../../utils/route-registry";
import FormattedDate from "../../components/FormattedDate.astro";
import ArticleHeadingEnhancements from "../../components/ArticleHeadingEnhancements.astro";
import LydieContent from "../../components/LydieContent.astro";
import RelatedDocumentCard from "../../components/RelatedDocumentCard.astro";
import { Heading } from "../../components/generic/Heading";
import { Container } from "../../components/Container";
import { articleTypographyClassName } from "../../utils/article-typography";

const { slug } = Astro.params;

const BLOG_COLLECTION_HANDLE = lydieApi.collections.blog;

type BlogDocument = lydieApi.CollectionApiDocument;
type RelatedDocument = {
  id: string;
  title: string;
  createdAt?: string;
  coverImage?: string | null;
  slug?: string;
  fields?: Record<string, unknown>;
};

function getMarketingSlug(value: unknown): string | null {
  if (typeof value !== "string") return null;
  const normalized = value.trim().replace(/^\/+|\/+$/g, "");
  return normalized.length > 0 ? normalized : null;
}

if (!slug) {
  return new Response(null, {
    status: 404,
    statusText: "Blog post not found",
  });
}

let document: BlogDocument;
try {
  const { documents } = await lydieApi.getCollectionDocuments(
    BLOG_COLLECTION_HANDLE,
    {
      includeRelated: true,
      relatedScope: "same_collection",
      relatedLimit: 4,
      filters: {
        slug,
      },
    } as unknown as Parameters<typeof lydieApi.getCollectionDocuments>[1],
  );

  document = documents[0] as BlogDocument;
} catch (error) {
  return new Response(null, {
    status: 404,
    statusText: "Blog post not found",
  });
}

if (!document) {
  return new Response(null, {
    status: 404,
    statusText: "Blog post not found",
  });
}

const blogPostProps = {
  title: document.title,
  description: String(document.fields?.excerpt || ""),
};

const articleUrl = new URL(
  `/blog/${document.fields?.slug || document.id}`,
  Astro.site,
);
const linkResolver = createLinkResolver({ currentCollectionHandle: BLOG_COLLECTION_HANDLE });
const imageUrl =
  typeof document.coverImage === "string"
    ? new URL(document.coverImage, Astro.site)
    : new URL("/blog.png", Astro.site);
const coverImageSrc =
  typeof document.coverImage === "string" ? imageUrl.toString() : "/blog.png";
const excerpt = String(document.fields?.excerpt || "");

const structuredData = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: document.title,
  description: excerpt,
  image: imageUrl.toString(),
  datePublished: document.createdAt,
  dateModified: document.updatedAt || document.createdAt,
  url: articleUrl.toString(),
  author: {
    "@type": "Organization",
    name: "Lydie",
    url: Astro.site?.toString() || "",
  },
  publisher: {
    "@type": "Organization",
    name: "Lydie",
    url: Astro.site?.toString() || "",
  },
};
---

<BlogPost {...blogPostProps}>
  <script
    type="application/ld+json"
    set:html={JSON.stringify(structuredData)}
  />
  <div class="py-16">
    <Container>
      <div class="mx-auto">
        <article class="max-w-2xl mx-auto flex flex-col gap-y-4">
          <div class="flex justify-center">
            <Breadcrumbs
              items={[
                { label: "Blog", href: "/blog" },
                { label: document.title },
              ]}
            />
          </div>
          <header class="flex flex-col gap-y-4 mb-4 text-center">
            <Heading className="text-4xl">{document.title}</Heading>
            {
              document.fields?.excerpt && (
                <p class="text-base text-gray-600">
                  {String(document.fields.excerpt)}
                </p>
              )
            }
            <span class="text-gray-500 text-sm">
              <FormattedDate date={new Date(String(document.createdAt))} />
            </span>
          </header>
          <div
            class="rounded-lg ring ring-black/5 overflow-hidden h-80 [&>img]:object-cover [&>img]:w-full [&>img]:h-80"
          >
            <Image
              src={coverImageSrc}
              alt=""
              width={672}
              height={320}
              layout="constrained"
              fit="cover"
              sizes="(max-width: 672px) 100vw, 672px"
              class="w-full h-80"
            />
          </div>
          <div class={`mt-12 ${articleTypographyClassName}`}>
            <LydieContent
              content={document.jsonContent as import("@lydie/core/content").ContentNode}
              linkResolver={linkResolver}
            />
          </div>
          <ArticleHeadingEnhancements />
          <hr class="my-8 border-gray-200" />
          <div class="flex flex-col gap-y-4">
            <span class="text-gray-500 text-sm"> Related posts </span>
            <div class="grid md:grid-cols-2 grid-cols-1 gap-3">
              {
                (document.related as RelatedDocument[] | undefined)?.map(
                  (post) => {
                    const relatedSlug = getMarketingSlug(
                      post.fields?.slug ?? post.slug,
                    );

                    return (
                      <RelatedDocumentCard
                        href={relatedSlug ? `/blog/${relatedSlug}` : `/blog/${post.id}`}
                        title={post.title}
                        createdAt={post.createdAt}
                        coverImage={post.coverImage}
                      />
                    );
                  },
                )
              }
            </div>
          </div>
        </article>
      </div>
    </Container>
  </div>
</BlogPost>
