---
export const prerender = false;

Astro.response.headers.set(
  "Cache-Control",
  "public, max-age=3600, s-maxage=86400, stale-while-revalidate=604800",
);

import { Image } from "astro:assets";
import BlogPost from "../../layouts/BlogPost.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import * as lydieApi from "../../utils/lydie-client";
import { createLinkResolver } from "../../utils/route-registry";
import FormattedDate from "../../components/FormattedDate.astro";
import LydieContent from "../../components/LydieContent.astro";
import { Heading } from "../../components/generic/Heading";
import { Container } from "../../components/Container";

const { slug } = Astro.params;

const BLOG_COLLECTION_ID = "YchJ11QUiAPpY8FC";

type BlogDocument = Awaited<
  ReturnType<typeof lydieApi.getCollectionDocuments>
>["documents"][number];
type RelatedDocument = {
  id: string;
  title: string;
  createdAt?: string;
  coverImage?: string;
  fields?: { slug?: string };
};

let document: BlogDocument;
try {
  const { documents } = await lydieApi.getCollectionDocuments(
    BLOG_COLLECTION_ID,
    {
      includeRelated: true,
      filters: { slug: slug! },
    },
  );

  if (!documents[0]) {
    throw new Error("Document not found");
  }

  document = documents[0];
} catch (error) {
  console.error(`Failed to fetch document with slug "${slug}":`, error);
  // Return 404 response for missing or errored documents
  return new Response(null, {
    status: 404,
    statusText: "Blog post not found",
  });
}

const blogPostProps = {
  title: document.title,
  description: String(document.fields?.excerpt || ""),
};

const articleUrl = new URL(
  `/blog/${document.fields?.slug || document.id}`,
  Astro.site,
);
const imageUrl =
  typeof document.coverImage === "string"
    ? new URL(document.coverImage, Astro.site)
    : new URL("/blog.png", Astro.site);
const coverImageSrc =
  typeof document.coverImage === "string" ? imageUrl.toString() : "/blog.png";
const excerpt = String(document.fields?.excerpt || "");

const structuredData = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: document.title,
  description: excerpt,
  image: imageUrl.toString(),
  datePublished: document.createdAt,
  dateModified: document.updatedAt || document.createdAt,
  url: articleUrl.toString(),
  author: {
    "@type": "Organization",
    name: "Lydie",
    url: Astro.site?.toString() || "",
  },
  publisher: {
    "@type": "Organization",
    name: "Lydie",
    url: Astro.site?.toString() || "",
  },
};
---

<BlogPost {...blogPostProps}>
  <script
    type="application/ld+json"
    set:html={JSON.stringify(structuredData)}
  />
  <div class="py-16">
    <Container>
      <div class="mx-auto">
        <article class="max-w-2xl mx-auto flex flex-col gap-y-4">
          <div class="flex justify-center">
            <Breadcrumbs
              items={[
                { label: "Blog", href: "/blog" },
                { label: document.title },
              ]}
            />
          </div>
          <header class="flex flex-col gap-y-4 mb-4 text-center">
            <Heading className="text-4xl">{document.title}</Heading>
            {
              document.fields?.excerpt && (
                <p class="text-base text-gray-600">
                  {String(document.fields.excerpt)}
                </p>
              )
            }
            <span class="text-gray-500 text-sm">
              <FormattedDate date={new Date(document.createdAt)} />
            </span>
          </header>
          <div
            class="rounded-lg ring ring-black/5 overflow-hidden h-80 [&>img]:object-cover [&>img]:w-full [&>img]:h-80"
          >
            <Image
              src={coverImageSrc}
              alt=""
              width={672}
              height={320}
              layout="constrained"
              fit="cover"
              sizes="(max-width: 672px) 100vw, 672px"
              class="w-full h-80"
            />
          </div>
          <div class="prose mt-12">
            <LydieContent
              content={document.jsonContent}
              linkResolver={createLinkResolver()}
            />
          </div>
          <hr class="my-8 border-gray-200" />
          <div class="flex flex-col gap-y-4">
            <span class="text-gray-500 text-sm"> Related posts </span>
            <div class="grid md:grid-cols-2 grid-cols-1 gap-2">
              {
                (document.related as RelatedDocument[] | undefined)?.map(
                  (post) => (
                    <a
                      href={`/blog/${post.fields?.slug || post.id}`}
                      class="rounded-lg bg-black/2 p-4 flex md:h-32 flex-col justify-end hover:bg-black/5 transition-colors duration-75 no-underline bg-center bg-cover bg-no-repeat"
                      style={
                        post.coverImage
                          ? `background-image: linear-gradient(to top, rgba(0,0,0,0.6), rgba(0,0,0,0.3)), url(${post.coverImage})`
                          : ""
                      }
                    >
                      <span
                        class="text-base font-medium text-ellipsis overflow-hidden whitespace-nowrap"
                        class:list={[
                          post.coverImage ? "text-white" : "text-gray-900",
                        ]}
                      >
                        {post.title}
                      </span>
                      <p
                        class="text-sm"
                        class:list={[
                          post.coverImage ? "text-white/80" : "text-gray-500",
                        ]}
                      >
                        <FormattedDate
                          date={new Date(post.createdAt || Date.now())}
                        />
                      </p>
                    </a>
                  ),
                )
              }
            </div>
          </div>
        </article>
      </div>
    </Container>
  </div>
</BlogPost>
