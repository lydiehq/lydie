---
export const prerender = false;

// ISR-like caching: CDN caches for 24 hours, serves stale for 7 days while revalidating
Astro.response.headers.set(
  "Cache-Control",
  "public, max-age=3600, s-maxage=86400, stale-while-revalidate=604800",
);

import Layout from "../../layouts/Layout.astro";
import { Container } from "../../components/Container";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import FormattedDate from "../../components/FormattedDate.astro";
import { GeometricPatternIllustration } from "../../components/illustrations/GeometricPatternIllustration";
import * as lydieApi from "../../utils/lydie-client";

const BLOG_COLLECTION_HANDLE = lydieApi.collections.blog;

type BlogListDocument = Awaited<
  ReturnType<typeof lydieApi.getCollectionDocuments>
>["documents"][number];

function toSlug(value: unknown): string | null {
  if (typeof value !== "string") return null;
  const normalized = value.trim().replace(/^\/+|\/+$/g, "");
  return normalized.length > 0 ? normalized : null;
}

function getPostHref(post: BlogListDocument): string {
  const slug = toSlug(post.fields?.slug);
  return slug ? `/blog/${slug}` : `/blog/${String(post.id)}`;
}

function getPostSeed(post: BlogListDocument): string {
  const slug = toSlug(post.fields?.slug);
  return `blog:${slug ?? String(post.id)}`;
}

function getPostDate(post: BlogListDocument): Date {
  const dateValue =
    typeof post.createdAt === "string"
      ? post.createdAt
      : typeof post.updatedAt === "string"
        ? post.updatedAt
        : "";

  const parsedDate = dateValue ? new Date(dateValue) : new Date(0);
  return Number.isNaN(parsedDate.getTime()) ? new Date(0) : parsedDate;
}

let posts: BlogListDocument[] = [];

try {
  console.log("[Blog] Fetching posts from collection:", BLOG_COLLECTION_HANDLE);
  const { documents } = await lydieApi.getCollectionDocuments(
    BLOG_COLLECTION_HANDLE,
  );
  posts = documents;
  console.log(`[Blog] Successfully fetched ${posts.length} blog posts`);
} catch (error) {
  console.error("[Blog] Failed to fetch blog posts:", error);
  posts = [];
}

const sortedPosts = posts.sort((a, b) => {
  const dateA = getPostDate(a);
  const dateB = getPostDate(b);
  return dateB.getTime() - dateA.getTime();
});

const featuredPost = sortedPosts[0];
const remainingPosts = sortedPosts.slice(1);
---

<Layout
  title="Blog -Â Lydie"
  description="Resources on writing, working in teams, and technical insights into Lydie."
>
  <div class="py-8">
    <Container>
      <Breadcrumbs items={[{ label: "Blog" }]} />
      <header class="flex flex-col gap-y-2 mb-12 mt-4">
        <h1 class="text-2xl font-medium text-gray-900">Blog</h1>
        <span class="text-base text-gray-700"
          >Resources on writing, working in teams, and technical insights into
          Lydie.</span
        >
      </header>

      {
        featuredPost && (
          <section class="overflow-visible -mx-2 px-2">
            <a href={getPostHref(featuredPost)} class="block group">
              <div class="rounded-xl bg-transparent group-hover:bg-gray-50 transition-colors duration-150 -m-2 p-2">
                <div class="flex gap-x-4 items-center">
                  <div class="w-72 aspect-video shrink-0">
                    <GeometricPatternIllustration
                      seed={getPostSeed(featuredPost)}
                      radius="md"
                    />
                  </div>
                  <div class="flex flex-col gap-y-2 p-6">
                    <h2 class="text-xl font-medium text-gray-900">
                      {featuredPost.title}
                    </h2>
                    {featuredPost.fields?.excerpt && (
                      <p class="text-gray-600 text-base">
                        {featuredPost.fields.excerpt}
                      </p>
                    )}
                    <p class="text-gray-500 text-xs">
                      <FormattedDate date={getPostDate(featuredPost)} />
                    </p>
                  </div>
                </div>
              </div>
            </a>
          </section>
        )
      }
      <hr class="border-gray-100 w-full my-12" />

      {
        remainingPosts.length > 0 && (
          <section>
            <ul class="gap-y-8 flex flex-col">
              {remainingPosts.map((post) => (
                <li>
                  <a
                    href={getPostHref(post)}
                    class="flex flex-col gap-y-3 group"
                  >
                    <div class="flex gap-x-4 items-center">
                      <div class="w-16 aspect-square shrink-0">
                        <GeometricPatternIllustration
                          seed={getPostSeed(post)}
                          columns={3}
                          rows={3}
                          minWhiteShapes={2}
                          radius="sm"
                        />
                      </div>
                      <div class="flex flex-col">
                        <h3 class="text-bsae font-medium text-gray-900">
                          {post.title}
                        </h3>
                        <div class="flex gap-x-2">
                          {post.createdAt && (
                            <span class="text-xs text-gray-500 whitespace-nowrap">
                              <FormattedDate date={getPostDate(post)} />
                            </span>
                          )}
                        </div>
                      </div>
                    </div>
                    <div class="flex-1 flex flex-col gap-y-1">
                      {post.fields?.excerpt && (
                        <p class="text-sm/relaxed text-gray-600 line-clamp-2 max-w-lg">
                          {post.fields.excerpt}
                        </p>
                      )}
                    </div>
                  </a>
                </li>
              ))}
            </ul>
          </section>
        )
      }
    </Container>
  </div>
</Layout>
