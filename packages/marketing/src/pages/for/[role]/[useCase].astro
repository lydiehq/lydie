---
import { Image } from "astro:assets";
import Layout from "@/layouts/Layout.astro";
import { Container } from "@/components/Container";
import Breadcrumbs from "@/components/Breadcrumbs.astro";
import { Button } from "@/components/generic/Button";
import { ChevronRightRegular } from "@fluentui/react-icons";
import { CTASection } from "@/components/landing/CTASection";
import { SectionHeader } from "@/components/landing/SectionHeader";
import { FAQ } from "@/components/generic/FAQ";
import { getRole, getAllRoles } from "@/data/roles";
import {
  getUseCaseDefinition,
  getAllUseCaseSlugs,
} from "@/data/use-case-definitions";
import { getRoleUseCaseContent } from "@/data/role-use-cases";
import { Heading } from "@/components/generic/Heading";
import { getTemplatesBySlugs } from "@/data/templates";
import TemplateThumbnail from "@/components/templates/TemplateThumbnail.astro";
import { getBlogPostsBySlugs } from "@/data/blog-posts";
import FormattedDate from "@/components/FormattedDate.astro";
import { Sections } from "@/components/landing/Sections";
import { resolveSections } from "@/data/sections";
import { UseCaseHero } from "@/components/landing/UseCaseHero";
import Divider from "@/components/landing/Divider.astro";
import { GradientOutline } from "@/components/generic/GradientOutline";

// Generate all valid role/use-case combinations (only those with role-use-case content)
export function getStaticPaths() {
  const paths: Array<{ params: { role: string; useCase: string } }> = [];
  const roles = getAllRoles();
  const useCases = getAllUseCaseSlugs();

  for (const role of roles) {
    for (const useCase of useCases) {
      const content = getRoleUseCaseContent(role.slug, useCase);
      if (content) {
        paths.push({
          params: { role: role.slug, useCase },
        });
      }
    }
  }

  return paths;
}

const { role: roleSlug, useCase: useCaseSlug } = Astro.params;
const role = getRole(roleSlug!);
const useCaseDef = getUseCaseDefinition(useCaseSlug!);
const content = getRoleUseCaseContent(roleSlug!, useCaseSlug!);

if (!role || !useCaseDef || !content) {
  return new Response(null, { status: 404 });
}

const {
  meta,
  hero,
  content: bodyContent,
  examples,
  faqs,
  statement,
  workflowExample,
  sections,
} = content;

// Get templates for this role+use case combination (up to 3)
const templateSlugs = content.templateSlugs?.slice(0, 3) ?? [];
const templates =
  templateSlugs.length > 0 ? await getTemplatesBySlugs(templateSlugs) : [];

// Get blog posts for this role+use case combination
const blogPostSlugs = content.blogPosts ?? [];
const blogPosts =
  blogPostSlugs.length > 0 ? await getBlogPostsBySlugs(blogPostSlugs) : [];
---

<Layout
  title={`${meta.title} - Lydie`}
  description={meta.description ?? hero.description}
>
  <Container className="flex flex-col gap-y-8 py-8">
    <Breadcrumbs
      items={[
        { label: "Lydie for", href: "/for" },
        {
          label:
            role.terms.actorPlural.charAt(0).toUpperCase() +
            role.terms.actorPlural.slice(1),
          href: `/for/${roleSlug}`,
        },
        { label: useCaseDef.terms.label },
      ]}
    />

    <UseCaseHero
      title={hero.title}
      description={hero.description}
      states={content.demoStates}
      client:load
    />
    <div class="flex flex-col gap-y-24 py-24">
      <section class="flex flex-col gap-y-6 max-w-[65ch] mx-auto">
        {
          bodyContent.map((paragraph) => (
            <p class="text-base/relaxed text-black/70">{paragraph}</p>
          ))
        }
      </section>

      {
        statement && (
          <section class="py-5">
            <blockquote class="text-lg font-medium text-gray-900 text-center max-w-3xl mx-auto leading-relaxed text-balance">
              "{statement}"
            </blockquote>
          </section>
        )
      }

      {
        workflowExample && (
          <>
            <Divider />
            <section class="grid grid-cols-1 md:grid-cols-5 md:gap-12">
              <SectionHeader
                title={workflowExample.title}
                description={workflowExample.description}
                className="col-span-1 md:col-span-2"
              />
              <div class="bg-gray-50 rounded-xl col-span-1 md:col-span-3 relative">
                <GradientOutline />
                <ol class="space-y-4">
                  {workflowExample.steps.map((step: string, index: number) => (
                    <li class="flex items-baseline gap-2">
                      <span class="shrink-0 size-7 ring ring-black/6 shadow-legit rounded-full bg-white text-gray-700 flex items-center justify-center text-sm font-medium">
                        {index + 1}
                      </span>
                      <p class="text-gray-700 text-sm/relaxed">{step}</p>
                    </li>
                  ))}
                </ol>
              </div>
            </section>
          </>
        )
      }
      {
        sections && sections.length > 0 && (
          <>
            <Divider />
            <section class="flex flex-col">
              <SectionHeader
                title={`Why ${role.terms.actorPlural} love Lydie`}
                description={`Discover why ${role.terms.actorPlural} choose Lydie for their work.`}
              />
              <Sections sections={resolveSections(sections)} client:load />
            </section>
          </>
        )
      }

      {
        templates.length > 0 && (
          <section class="flex flex-col gap-y-8">
            <SectionHeader
              title={`Templates for ${useCaseDef.terms.act}`}
              description={`Get started quickly with these pre-built templates for ${role.shortTitle.toLowerCase()}:`}
            />
            <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
              {templates.map((template) => (
                <TemplateThumbnail
                  name={template.name}
                  teaser={template.teaser}
                  href={`/templates/${template.slug}`}
                  slug={template.slug}
                  thumbnailSrc={template.thumbnailSrc}
                />
              ))}
            </div>
          </section>
        )
      }

      {
        blogPosts.length > 0 && (
          <section class="flex flex-col gap-y-8">
            <SectionHeader
              title={`Learn more about ${useCaseDef.terms.act}`}
              description="Explore our articles on this topic:"
            />
            <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
              {blogPosts.map((post) => (
                <a
                  href={`/blog/${post.slug}`}
                  class="group flex flex-col gap-y-4"
                >
                  <div class="rounded-lg shadow-surface aspect-video overflow-hidden shrink-0 [&>img]:object-cover [&>img]:w-full [&>img]:h-full">
                    <Image
                      src={
                        post.coverImage
                          ? new URL(post.coverImage, Astro.site).toString()
                          : "/blog.png"
                      }
                      alt=""
                      width={640}
                      height={360}
                      layout="constrained"
                      fit="cover"
                      class="w-full h-full group-hover:scale-105 transition-transform duration-300"
                    />
                  </div>
                  <div class="flex flex-col gap-y-2">
                    <h3 class="text-base font-medium text-gray-900 group-hover:text-gray-700 transition-colors">
                      {post.title}
                    </h3>
                    {post.createdAt && (
                      <p class="text-xs text-gray-500">
                        <FormattedDate date={new Date(post.createdAt)} />
                      </p>
                    )}
                  </div>
                </a>
              ))}
            </div>
          </section>
        )
      }
    </div>

    {/* Examples */}
    <!-- <section class="bg-gray-50 rounded-2xl p-8 sm:p-12">
      <SectionHeader
        title={`How ${role.shortTitle.toLowerCase()} use ${useCaseDef.terms.act}`}
        description={`Concrete examples of ${useCaseDef.terms.act} for ${role.shortTitle.toLowerCase()}:`}
        className="mb-8"
      />
      <div class="grid sm:grid-cols-3 gap-6">
        {
          examples.map((example) => (
            <div class="flex flex-col gap-y-2">
              <h3 class="font-semibold text-gray-900">{example.title}</h3>
              <p class="text-gray-600 text-sm">{example.description}</p>
            </div>
          ))
        }
      </div>
    </section> -->

    <!-- <section class="flex flex-col gap-y-8">
      <SectionHeader
        title={`Benefits of using Lydie for ${useCaseDef.terms.act}`}
      />
      <div class="grid sm:grid-cols-2 gap-4">
        {
          useCaseDef.benefits.map((benefit) => (
            <div class="flex items-start gap-x-3 p-4 rounded-lg border border-gray-200">
              <div class="shrink-0 w-5 h-5 rounded-full bg-green-100 flex items-center justify-center mt-0.5">
                <svg
                  class="w-3 h-3 text-green-600"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 13l4 4L19 7"
                  />
                </svg>
              </div>
              <p class="text-black/70">{benefit}</p>
            </div>
          ))
        }
      </div>
    </section> -->
    {
      faqs.length > 0 && (
        <section class="max-w-xl mx-auto w-full">
          <FAQ items={faqs} client:load />
        </section>
      )
    }
    <!-- <section
      class="flex flex-col gap-y-4 items-center text-center py-8 border-t border-gray-200"
    >
      <p class="text-black/60">
        Explore more use cases for {role.shortTitle}
      </p>
      <Button href={`/for/${roleSlug}`} size="lg" intent="secondary">
        <span>See all {role.shortTitle} workflows</span>
        <ChevronRightRegular className="size-4" />
      </Button>
    </section> -->
  </Container>
  <CTASection />
</Layout>
