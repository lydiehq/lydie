---
import Layout from "../../layouts/Layout.astro";
import Container from "../../components/Container.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import { Button } from "../../components/generic/Button";
import { ChevronRightRegular } from "@fluentui/react-icons";
import { DemoWithSelector } from "../../components/landing/DemoWithSelector";
import { FeatureSection } from "../../components/landing/FeatureSection";
import "../../styles/grainy-gradient.css";
import { CTASection } from "../../components/landing/CTASection";
import Divider from "../../components/landing/Divider.astro";
import { SectionHeader } from "../../components/landing/SectionHeader";
import TemplateThumbnail from "../../components/templates/TemplateThumbnail.astro";
import { FAQSection } from "../../components/tools/FAQSection";
import { getTemplatesByIds } from "../../data/templates";
import { useCases, type UseCase, getUseCase } from "../../data/use-cases";
import type { DemoState } from "../../components/landing/DemoStateSelector";
import { Heading } from "../../components/generic/Heading";

export function getStaticPaths() {
  return useCases.map((useCase) => ({
    params: { slug: useCase.slug },
  }));
}

const { slug } = Astro.params;
const useCase: UseCase | undefined = getUseCase(slug!);

if (!useCase) {
  return Astro.redirect("/404");
}

const {
  metaTitle,
  metaDescription,
  title,
  description,
  faqs,
  demoStates,
  ctaText,
  templates: templateIds,
  sections,
} = useCase;

// Fetch templates for this use case using efficient batch query
const fetchedTemplates = templateIds?.length
  ? await getTemplatesByIds(templateIds)
  : [];
const validTemplates = fetchedTemplates.filter(
  (t): t is NonNullable<typeof t> => t !== undefined,
);
---

<Layout title={metaTitle} description={metaDescription}>
  <Container
    className="flex flex-col items-center justify-center min-h-[60vh] py-8 gap-y-12"
  >
    <div class="w-full">
      <Breadcrumbs
        items={[{ label: "Use cases", href: "/use-cases" }, { label: title }]}
      />
    </div>
    <div class="text-center relative py-8 size-full">
      <div
        class="flex flex-col max-w-md mx-auto text-center items-center gap-y-6"
      >
        <Heading className="text-4xl">
          {metaTitle.replace(" - Lydie", "")}
        </Heading>
        <p class="text-base text-black/60 mx-auto text-balance">
          {description}
        </p>
        <div class="flex items-center justify-center gap-4">
          <Button href="https://app.lydie.co/auth" size="lg" intent="primary">
            <span>{ctaText}</span>
            <ChevronRightRegular className="size-4" />
          </Button>
        </div>
      </div>
    </div>
    <DemoWithSelector
      client:load
      states={demoStates}
      initialState={demoStates[0]}
    />

    <!-- Feature Sections -->
    {
      sections && sections.length > 0 && (
        <div class="w-full space-y-16 md:space-y-24">
          {sections.map((section: { illustration: DemoState; title: string; content: string; featureSlug: string }, index: number) => (
            <FeatureSection
              client:load
              illustration={section.illustration}
              title={section.title}
              content={section.content}
              featureSlug={section.featureSlug}
              reverse={index % 2 === 1}
            />
          ))}
        </div>
      )
    }

    <Divider />
    <section class="flex flex-col md:flex-row gap-8 w-full">
      <SectionHeader
        title="Templates"
        description="Here are some templates that you can use to get started with Lydie."
        className="max-w-sm"
      />
      <div class="grid grid-cols-1 gap-4 md:grid-cols-3 grow">
        {
          validTemplates.length > 0 ? (
            validTemplates.map(
              (template: {
                name: string;
                teaser: string;
                slug: string;
                thumbnailSrc: string | null;
              }) => (
                <TemplateThumbnail
                  name={template.name}
                  teaser={template.teaser}
                  href={`/templates/${template.slug}`}
                  slug={template.slug}
                  thumbnailSrc={template.thumbnailSrc}
                />
              ),
            )
          ) : (
            <p class="text-gray-500 col-span-3">
              No templates available for this use case.
            </p>
          )
        }
      </div>
    </section>
    <Divider />
    <div class="max-w-xl mx-auto">
      <FAQSection faqs={faqs} client:load />
    </div>
  </Container>
  <CTASection client:load />
</Layout>
