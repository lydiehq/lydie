---
import { Image } from "astro:assets";
import Layout from "../../layouts/Layout.astro";
import { Container } from "../../components/Container";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import { ChevronRightRegular } from "@fluentui/react-icons";
import { CTASection } from "../../components/landing/CTASection";
import { SectionHeader } from "../../components/landing/SectionHeader";
import {
  getUseCaseDefinition,
  getAllUseCaseSlugs,
} from "../../data/use-case-definitions";
import { getRolesToDisplayForUseCase } from "../../data/role-use-cases";
import { getAllRoles } from "../../data/roles";
import { Sections } from "../../components/landing/Sections";
import { resolveSections } from "../../data/sections";
import { getTemplatesBySlugs } from "../../data/templates";
import TemplateThumbnail from "../../components/templates/TemplateThumbnail.astro";
import { getBlogPostsBySlugs } from "../../data/blog-posts";
import FormattedDate from "../../components/FormattedDate.astro";
import { FAQ } from "../../components/generic/FAQ";
import { UseCaseHero } from "@/components/landing/UseCaseHero";
import Divider from "@/components/landing/Divider.astro";

export function getStaticPaths() {
  const useCaseSlugs = getAllUseCaseSlugs();
  return useCaseSlugs.map((slug) => ({
    params: { slug },
  }));
}

const { slug } = Astro.params;
const useCase = getUseCaseDefinition(slug!);

if (!useCase) {
  return new Response(null, { status: 404 });
}

const allRoles = getAllRoles();

// Get templates for this use case (up to 3)
const templateSlugs = useCase.templateSlugs?.slice(0, 3) ?? [];
const templates =
  templateSlugs.length > 0 ? await getTemplatesBySlugs(templateSlugs) : [];

// Get blog posts for this use case
const blogPostSlugs = useCase.blogPosts ?? [];
const blogPosts =
  blogPostSlugs.length > 0 ? await getBlogPostsBySlugs(blogPostSlugs) : [];

// Get roles to display (featured first, then auto-linked up to 4 total)
const rolesToDisplay = getRolesToDisplayForUseCase(useCase);
---

<Layout
  title={`${useCase.meta.title} - Lydie`}
  description={useCase.meta.description ?? useCase.thumbnail.description}
>
  <Container className="flex flex-col gap-y-16 py-16">
    <Breadcrumbs
      items={[
        { label: "Use cases", href: "/use-cases" },
        { label: useCase.thumbnail.title },
      ]}
    />
    <UseCaseHero
      title={useCase.hero.title}
      description={useCase.hero.description}
      states={useCase.demoStates}
      client:load
    />

    {
      useCase.statement && (
        <section class="py-5">
          <blockquote class="text-lg font-medium text-gray-900 text-center max-w-3xl mx-auto leading-relaxed text-balance">
            "{useCase.statement}"
          </blockquote>
        </section>
      )
    }
    <!-- {
      useCase.problemsAndSolutions && (
        <section class="flex flex-col gap-y-6">
          <SectionHeader
            title={useCase.problemsAndSolutions.title}
            description="How Lydie solves common challenges"
          />
          <div class="space-y-4">
            {useCase.problemsAndSolutions.problems.map((item) => (
              <div class="flex flex-col sm:flex-row sm:items-start gap-4 p-5 rounded-xl border border-gray-200">
                <div class="flex-1">
                  <p class="font-medium text-gray-900 mb-1">{item.problem}</p>
                  <p class="text-gray-600 text-sm">{item.solution}</p>
                </div>
              </div>
            ))}
          </div>
        </section>
      )
    } -->

    {
      useCase.workflowExample && (
        <section class="flex flex-col gap-y-6">
          <SectionHeader
            title={useCase.workflowExample.title}
            description={useCase.workflowExample.description}
          />
          <div class="bg-gray-50 rounded-xl p-6 sm:p-8">
            <ol class="space-y-4">
              {useCase.workflowExample.steps.map((step, index) => (
                <li class="flex items-start gap-4">
                  <span class="shrink-0 w-8 h-8 rounded-full bg-gray-900 text-white flex items-center justify-center text-sm font-medium">
                    {index + 1}
                  </span>
                  <p class="text-gray-700 leading-relaxed pt-1">{step}</p>
                </li>
              ))}
            </ol>
          </div>
        </section>
      )
    }

    <!-- {
      useCase.differentiation && (
        <section class="flex flex-col gap-y-6">
          <SectionHeader title={useCase.differentiation.title} />
          <div class="grid sm:grid-cols-2 gap-4">
            {useCase.differentiation.points.map((point) => (
              <div class="p-5 rounded-xl border border-gray-200">
                <h3 class="font-medium text-gray-900 mb-2">{point.label}</h3>
                <p class="text-gray-600 text-sm leading-relaxed">
                  {point.description}
                </p>
              </div>
            ))}
          </div>
        </section>
      )
    } -->

    {
      useCase.sections && useCase.sections.length > 0 && (
        <section class="flex flex-col gap-y-8">
          <Sections sections={resolveSections(useCase.sections)} client:load />
        </section>
      )
    }
    {
      templates.length > 0 && (
        <section class="flex flex-col gap-y-8">
          <SectionHeader
            title={`Templates for ${useCase.thumbnail.title.toLowerCase()}`}
            description="Get started quickly with these pre-built templates:"
          />
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {templates.map((template) => (
              <TemplateThumbnail
                name={template.name}
                teaser={template.teaser}
                href={`/templates/${template.slug}`}
                slug={template.slug}
                thumbnailSrc={template.thumbnailSrc}
              />
            ))}
          </div>
        </section>
      )
    }

    {
      blogPosts.length > 0 && (
        <section class="flex flex-col gap-y-8">
          <SectionHeader
            title={`Learn more about ${useCase.thumbnail.title.toLowerCase()}`}
            description="Explore our articles on this topic:"
          />
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {blogPosts.map((post) => (
              <a
                href={`/blog/${post.slug}`}
                class="group flex flex-col gap-y-4"
              >
                <div class="rounded-lg shadow-surface aspect-video overflow-hidden shrink-0 [&>img]:object-cover [&>img]:w-full [&>img]:h-full">
                  <Image
                    src={
                      post.coverImage
                        ? new URL(post.coverImage, Astro.site).toString()
                        : "/blog.png"
                    }
                    alt=""
                    width={640}
                    height={360}
                    layout="constrained"
                    fit="cover"
                    class="w-full h-full group-hover:scale-105 transition-transform duration-300"
                  />
                </div>
                <div class="flex flex-col gap-y-2">
                  <h3 class="text-base font-medium text-gray-900 group-hover:text-gray-700 transition-colors">
                    {post.title}
                  </h3>
                  {post.createdAt && (
                    <p class="text-xs text-gray-500">
                      <FormattedDate date={new Date(post.createdAt)} />
                    </p>
                  )}
                </div>
              </a>
            ))}
          </div>
        </section>
      )
    }

    <Divider logo />

    {
      rolesToDisplay.length > 0 && (
        <section class="flex flex-col gap-y-8">
          <SectionHeader
            title={`How different people use Lydie for ${useCase.thumbnail.title.toLowerCase()}`}
            description="See how professionals across different fields capture and organize their knowledge:"
          />
          <div class="grid sm:grid-cols-2 gap-6">
            {rolesToDisplay.map(({ role, description }) => (
              <a
                href={`/for/${role.slug}/${slug}`}
                class="group flex flex-col gap-y-3 p-6 rounded-xl border border-gray-200 bg-white hover:border-gray-300 hover:shadow-md transition-all duration-200"
              >
                <h3 class="text-lg font-semibold text-gray-900 group-hover:text-gray-950 transition-colors">
                  How {role.terms.actorPlural} use Lydie for {useCase.terms.act}
                </h3>
                <p class="text-gray-600 text-[15px]/relaxed">{description}</p>
                <div class="flex items-center gap-x-1 text-sm font-medium text-gray-900 group-hover:text-gray-700 transition-colors mt-auto pt-2">
                  <span>Learn more</span>
                  <ChevronRightRegular className="size-4 group-hover:translate-x-0.5 transition-transform" />
                </div>
              </a>
            ))}
          </div>
        </section>
      )
    }

    {
      useCase.faqs && useCase.faqs.length > 0 && (
        <section class="max-w-3xl mx-auto w-full">
          <FAQ items={useCase.faqs} client:load />
        </section>
      )
    }
  </Container>
  <CTASection />
</Layout>
